# MCSampleGen

## Prerequisites

CernVM-FS

## Setup 

    git clone https://github.com/zctao/MCSampleGen.git
    . setupEnv.sh 
    
Set up MadGraph5_aMC@NLO

    wget https://launchpad.net/mg5amcnlo/2.0/2.8.x/+download/MG5_aMC_v2.8.2.tar.gz
    tar -zxf MG5_aMC_v2.8.2.tar.gz
    mv MG5_aMC_v2_8_2 MG5_aMC
    
Install Pythia8, Delphes, MA5 (optional) from the MadGraph5_aMC@NLO prompt

    cd MG5_aMC
    python bin/mg5_aMC
    
    MG5_aMC>install pythia8
    MG5_aMC>install Delphes
    MG5_aMC>install MadAnalysis5

## Usage

### Generate ttbar MC events

The main script to run is `script/writeJobFile.py`.
It produces a bash script (default name `generateTTbar.sh`) that can be either executed on the local machine or submitted to a PBS batch system.

The events are generated by MadGraph5 (LO or NLO), optionally decayed by MadSpin. Events are showered by Pythia8, and the detector response is simulated using Delphes.

For example, to produce 10,000 ttbar events

    python script/writeJobFile.py ttbar_test -n 10000 -f generateTTbar.sh

Run the script to generate the ttbar events

    . generateTTbar.sh

Or submit the job to PBS

    qsub -l walltime=<hh:mm:ss> generateTTbar.sh
    
To see more argument options

    python script/writeJobFile.py -h

For more usage exmaples, see also

    test/write_genTTbar.sh
    test/write_genTTbar_all.sh

### Generate zprime -> ttbar events

Download the model from
http://feynrules.irmp.ucl.ac.be/wiki/WZPrimeAtNLO

    wget http://feynrules.irmp.ucl.ac.be/raw-attachment/wiki/WZPrimeAtNLO/VPrime_NLO_UFO.tgz
    tar -zxvf VPrime_NLO_UFO.tgz

Place the model directory under `MG5_aMC/models/`

    mv VPrime_NLO MG5_aMC/models/.

Switch the generated event type to zprime via the command line option
`-e` when running `script/writeJobFile.py`

    python script/writeJobFile.py zprime_test -e zprime -f generateZprime.sh

### Make plots

Make histograms from Delphes output files

    python script/plotDelphesOut.py <delphes_events_files> [-o outname] [-w] [-s]

Collect histograms and make comparison plots

    python script/comparePlots.py <root_files_containing_histograms> [-l labels] [-o outname] [-n]

### Produce flat ntuples

To produce flat ntuples as well as numpy arrays from the Delphes root files

    python script/makeDelphesNtuple.py <delphes_events_files> [-o outname] [-t treename] [-f npz|h5] [-n nevents]

Reco-level event selections are applied in this step.

See also `test/submitNtupler.sh` for an example to submit the ntuple making job to the batch system.
